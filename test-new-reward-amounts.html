<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test New Reward Amounts</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 500px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        input {
            width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
        }
        .reward-summary {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Test New Reward Amounts</h1>
        <p>This tool verifies the updated reward system is working correctly.</p>
        
        <div class="reward-summary">
            <h3>üìã New Milestone-Based Reward Structure:</h3>
            <ul>
                <li><strong>Registration:</strong> 0 points (down from 200)</li>
                <li><strong>Referrer:</strong> 50 credits ONLY after 2 successful referrals</li>
                <li><strong>Referred Users:</strong> 25 points each ONLY when referrer reaches 2 friends</li>
                <li><strong>Before 2 referrals:</strong> No rewards given to anyone</li>
            </ul>
            <p style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                <strong>‚ö†Ô∏è Important:</strong> Rewards are only distributed when the referrer reaches exactly 2 successful referrals.
            </p>
        </div>
        
        <div style="margin: 20px 0;">
            <input type="text" id="userEmail" placeholder="Enter user email to check rewards" value="">
            <button onclick="checkUserRewards()">Check User Rewards</button>
        </div>
        
        <button onclick="checkRecentActivities()">Check Recent Activities</button>
        <button onclick="verifyRewardAmounts()">Verify All Reward Amounts</button>
        
        <div id="results"></div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://uhupwdeyykawbwejlhtb.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVodXB3ZGV5eWthd2J3ZWpsaHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxOTQ4MTksImV4cCI6MjA2Mzc3MDgxOX0.45CGgglVXmHFmmZYd1_sqnGlNVCfzs0T-CVwrAkauu8'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        function showResults(content, type = 'info') {
            const results = document.getElementById('results')
            results.innerHTML = content
            results.className = `results ${type}`
        }

        async function checkUserRewards() {
            const email = document.getElementById('userEmail').value.trim()
            if (!email) {
                showResults('‚ùå Please enter a user email', 'error')
                return
            }

            showResults('Checking user rewards...', 'info')

            try {
                // Get user by email
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email.toLowerCase())
                    .single()

                if (userError) {
                    showResults(`‚ùå User not found: ${userError.message}`, 'error')
                    return
                }

                let result = `üîç REWARD VERIFICATION FOR: ${user.full_name} (${user.email})\n\n`

                // Get user activities
                const { data: activities, error: activitiesError } = await supabase
                    .from('user_activities')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false })

                if (activities && activities.length > 0) {
                    result += `üìã ACTIVITIES ANALYSIS:\n`
                    
                    let registrationPoints = 0
                    let referralCredits = 0
                    let referralPoints = 0
                    
                    activities.forEach((activity, index) => {
                        result += `   ${index + 1}. ${activity.activity_type}: ${activity.description}\n`
                        result += `      Points: ${activity.reward_points}, Credits: ${activity.reward_amount}\n`
                        result += `      Date: ${new Date(activity.created_at).toLocaleString()}\n`
                        
                        // Track specific reward types
                        if (activity.activity_type === 'registration') {
                            registrationPoints += activity.reward_points
                        } else if (activity.activity_type === 'referral') {
                            referralCredits += activity.reward_amount
                            referralPoints += activity.reward_points
                        }
                        result += '\n'
                    })
                    
                    result += `üìä REWARD BREAKDOWN:\n`
                    result += `   Registration Points: ${registrationPoints} (should be 0)\n`
                    result += `   Referral Credits: ${referralCredits} (should be 50 per referral made)\n`
                    result += `   Referral Points: ${referralPoints} (should be 25 per referral used)\n\n`
                    
                    // Validation
                    result += `‚úÖ VALIDATION:\n`
                    if (registrationPoints === 0) {
                        result += `   ‚úÖ Registration points correct (0)\n`
                    } else {
                        result += `   ‚ùå Registration points incorrect (${registrationPoints}, should be 0)\n`
                    }
                    
                    // Check if amounts match new structure
                    const referralActivities = activities.filter(a => a.activity_type === 'referral')
                    let correctReferralRewards = true
                    
                    referralActivities.forEach(activity => {
                        if (activity.reward_amount > 0 && activity.reward_amount !== 50) {
                            correctReferralRewards = false
                            result += `   ‚ùå Incorrect referral credit amount: ${activity.reward_amount} (should be 50)\n`
                        }
                        if (activity.reward_points > 0 && activity.reward_points !== 25) {
                            correctReferralRewards = false
                            result += `   ‚ùå Incorrect referral point amount: ${activity.reward_points} (should be 25)\n`
                        }
                    })
                    
                    if (correctReferralRewards && referralActivities.length > 0) {
                        result += `   ‚úÖ Referral rewards correct (50 credits, 25 points)\n`
                    } else if (referralActivities.length === 0) {
                        result += `   ‚ÑπÔ∏è No referral activities found\n`
                    }
                    
                } else {
                    result += `üìã No activities found for this user\n\n`
                }

                // Get user stats
                const { data: stats, error: statsError } = await supabase
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', user.id)
                    .single()

                if (stats) {
                    result += `üí∞ CURRENT TOTALS:\n`
                    result += `   Points: ${stats.total_points}\n`
                    result += `   Credits: ${stats.total_credits_earned}\n`
                    result += `   Referrals: ${stats.total_referrals}\n\n`
                } else {
                    result += `‚ö†Ô∏è No stats found for this user\n\n`
                }

                result += `‚úÖ Analysis complete!`
                showResults(result, 'success')

            } catch (error) {
                showResults(`‚ùå Error: ${error.message}`, 'error')
            }
        }

        async function checkRecentActivities() {
            showResults('Checking recent activities...', 'info')

            try {
                const { data: activities, error } = await supabase
                    .from('user_activities')
                    .select(`
                        *,
                        users(full_name, email)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(20)

                if (error) {
                    showResults(`‚ùå Error: ${error.message}`, 'error')
                    return
                }

                let result = `üîÑ RECENT ACTIVITIES (Last 20):\n\n`

                activities.forEach((activity, index) => {
                    result += `${index + 1}. ${activity.users.full_name} - ${activity.activity_type}\n`
                    result += `   Description: ${activity.description}\n`
                    result += `   Points: ${activity.reward_points}, Credits: ${activity.reward_amount}\n`
                    result += `   Date: ${new Date(activity.created_at).toLocaleString()}\n`
                    
                    // Check if rewards match new structure
                    if (activity.activity_type === 'registration' && activity.reward_points !== 0) {
                        result += `   ‚ö†Ô∏è WARNING: Registration should give 0 points, got ${activity.reward_points}\n`
                    }
                    if (activity.activity_type === 'referral' && activity.reward_amount > 0 && activity.reward_amount !== 50) {
                        result += `   ‚ö†Ô∏è WARNING: Referral should give 50 credits, got ${activity.reward_amount}\n`
                    }
                    if (activity.activity_type === 'referral' && activity.reward_points > 0 && activity.reward_points !== 25) {
                        result += `   ‚ö†Ô∏è WARNING: Referral should give 25 points, got ${activity.reward_points}\n`
                    }
                    
                    result += '\n'
                })

                if (activities.length === 0) {
                    result += `No recent activities found.`
                }

                showResults(result, 'success')

            } catch (error) {
                showResults(`‚ùå Error: ${error.message}`, 'error')
            }
        }

        async function verifyRewardAmounts() {
            showResults('Verifying all reward amounts...', 'info')

            try {
                const { data: activities, error } = await supabase
                    .from('user_activities')
                    .select('*')
                    .order('created_at', { ascending: false })

                if (error) {
                    showResults(`‚ùå Error: ${error.message}`, 'error')
                    return
                }

                let result = `üîç REWARD AMOUNT VERIFICATION:\n\n`
                
                let registrationIssues = 0
                let referralCreditIssues = 0
                let referralPointIssues = 0
                let correctActivities = 0

                activities.forEach(activity => {
                    if (activity.activity_type === 'registration') {
                        if (activity.reward_points !== 0) {
                            registrationIssues++
                        } else {
                            correctActivities++
                        }
                    } else if (activity.activity_type === 'referral') {
                        if (activity.reward_amount > 0 && activity.reward_amount !== 50) {
                            referralCreditIssues++
                        } else if (activity.reward_points > 0 && activity.reward_points !== 25) {
                            referralPointIssues++
                        } else {
                            correctActivities++
                        }
                    }
                })

                result += `üìä SUMMARY:\n`
                result += `   Total activities checked: ${activities.length}\n`
                result += `   Correct reward amounts: ${correctActivities}\n`
                result += `   Registration issues: ${registrationIssues} (should give 0 points)\n`
                result += `   Referral credit issues: ${referralCreditIssues} (should give 50 credits)\n`
                result += `   Referral point issues: ${referralPointIssues} (should give 25 points)\n\n`

                if (registrationIssues === 0 && referralCreditIssues === 0 && referralPointIssues === 0) {
                    result += `‚úÖ All reward amounts are correct!\n`
                    showResults(result, 'success')
                } else {
                    result += `‚ö†Ô∏è Some reward amounts need to be updated.\n`
                    result += `This is expected if you have old activities from before the reward change.\n`
                    showResults(result, 'warning')
                }

            } catch (error) {
                showResults(`‚ùå Error: ${error.message}`, 'error')
            }
        }
    </script>
</body>
</html> 